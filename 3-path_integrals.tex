\chapter{Path Integrals and Feynman--Kac formulae}

\label{ch:feynman_kac}

The imaginary-time path integral is a powerful way to represent stochastic processes.  
If stochastic paths are sampled from path integral, then the path's evolution is governed by stochastic
differential equations or Langevin equations.
The path integral is also the solution to the diffusion or Fokker-Planck equation~\cite{Karatzas1991, Durrett1996}.
This connects the path integral with other tools used in physics to describe stochastic processes~\cite{Gardiner2009}.
The fact that path integrals are solutions to diffusion equations is known as the Feynman--Kac formula
after Feynman's work in describing the evolution of a quantum particle~\cite{Feynman1950},  and Kac's
work applying this to the diffusion equation~\cite{Kac1949}.
The term ``Feynman--Kac formula'' is also sometimes to refer to the analytical result for a specific path integral,
with a given potential.  

This chapter is devoted to deriving the Feynman--Kac formula, and then solving
it for planar geometries that are useful for both TE and TM polarizations.
These analytical formulae will be used in Ch.~\ref{ch:analytical} to show agreement 
with known results for both Casimir and Casimir--Polder energies.
The Feynman--Kac formula is also essential for handling the singular potentials.  
In fact, these analytical results are necessary to even allow the TM numerics to proceed at all.
These analytical solutions are also useful in accelerating numerical methods relying 
on stochastic simulations.  

\section{Derivation of the Feynman--Kac formula }

In this section, we will derive the path integral as the solution to a diffusion equation,
using techniques from quantum mechanics.
The derivation will stay close in spirit to the one presented in Sakurai~\cite{Sakurai1994}, but it will
be extended to include a source term, as is more common for stochastic processes.
More formal derivations are available from mathematical~\cite{Cartier2004},
and probabilistic perspectives~\cite{Karatzas1991, Durrett1996}.  
A detailed discussion of the more formal probabilistic derivation is available in Steck \S 17.9~\cite{SteckNotes}.

We aim to find a solution $f(\vect{x},t)$ to the driven diffusion equation
\begin{equation}
  \partial_t f = \frac{1}{2}\nabla^2 f  - [V+\lambda]f +g,\label{eq:diffusion_equation}
\end{equation}
where the potential is given by $V=V(\vect{x})$, $\lambda$ is a constant, and the source term is $g=g(\vect{x},t)$.  
In this form $f$ corresponds to the probability distribution for a diffusing particle with a source
of particles $g$, with spatially dependent killing rate $V$.  
The Schr\"odinger equation is recovered under the $\tau\rightarrow -it$ substitution.
The differential equation can be written in operator form using the same Hilbert space 
conventions~(\ref{eq:commutation})--(\ref{eq:identity}) were used for the worldline path integrals.
Note that $\hbar=1$ in this auxiliary Hilbert space.
The diffusion equation~(\ref{eq:diffusion_equation}) can be written in operator form
\begin{equation}
  \partial_t\langle \vect{x}|f(t)\rangle = -\langle \vect{x}|
  \left[\frac{1}{2}\op{\vect{p}}^2 + V(\op{\vect{x}})+\lambda\right]|f(t)\rangle +\langle \vect{x}|g(t)\rangle.
\end{equation}
This can be solved in analogy with solving the Schr\"odinger equation for a time-dependent Hamiltonian,
 by introducing the evolution operator,
\begin{equation}
  U(t,0) := \text{T}\exp\left\{-\int_0^t ds\left[\frac{1}{2}\op{\vect{p}}^2 + V(\op{\vect{x}})+\lambda\right]\right\},
\end{equation}
where $\text{T}$ is the time-ordering operator.  The time-ordering operator puts operators from right-to-left
in order of increasing time.  
We can then use the operator analogue of an integrating factor method, by transforming 
to the Heisenberg picture where $|f\rangle \rightarrow |\tilde{f}\rangle:=U^{-1}(t,0)|f\rangle$.  
The transformed vectors obey
\begin{equation}
  \partial_t|\tilde{f}\rangle = U^{-1}(t,0)|\tilde{g}\rangle.
\end{equation}
This equation can be formally integrated with respect to time,
and after transforming back to the original vectors we find
\begin{equation}
  |f(t)\rangle = U(t,0)|f(0)\rangle + U(t,0) \int_0^t ds\, U^{-1}(s,0)|g(s)\rangle,
\end{equation}
where $|\tilde{g}(t)\rangle = U^{-1}(t)|g(t)\rangle$.  
After combining the evolution operators, the solution is
\begin{equation}
  f(\vect{x}_f,t) = \langle \vect{x}_f|U(t,0)|f(0)\rangle + \int_0^t ds \langle \vect{x}_f|U(t,s)|g(s)\rangle.
  \label{eq:op_soln}
\end{equation}

The matrix elements have the same form,
\begin{equation}
  M = \langle \vect{x}_f|U(t)|f\rangle,
\end{equation}
where $U$ is the time-ordered evolution operator, and for time-independent Hamiltonians 
it can be split into a product of terms.
\begin{equation}
  U(t) = T\exp\left[-\int_0^t du\, H(u) \right] = \prod_{n=1}^N e^{-\Delta t \op{H}}
\end{equation}
% The path integral litany of 1) splitting evolution operator into short-time evolution operators,
% 2) inserting identities, 3) splitting position and momentum operators, 4) replacing operators with eigenvalues
% 5) integrating out momenta 
% can be followed once again. 
Position and momentum identities can be inserted between each term, with the result that
\begin{align}
  M %&= \langle \vect{x}_f| e^{-\Delta t \op{H}(t_N)}|f\rangle%\\
%   &= \int \frac{d\vect{p}_N}{(2\pi)^{D/2}}\langle \vect{x}_N|e^{-\Delta t \op{H}(t_N)} |\vect{p}_N\rangle \langle \vect{p}_N|
% \prod_{j=1}^{N-1} e^{-\Delta t \op{H}(t_j)}|f\rangle\\
  = e^{-\lambda t}\int \prod_{k=0}^{N-1}\frac{d\vect{x}_{k}d\vect{p}_k}{(2\pi)^{D/2}}
  \prod_{j=1}^{N}\left[\langle \vect{x}_{k+1}| e^{-\Delta t \op{H}}|\vect{p}_k\rangle
    \langle \vect{p}_k| \vect{x}_{k}\rangle \right]
  \langle \vect{x}_0| f\rangle.
\end{align}
Since $\lambda$ in constant, $e^{-\lambda \cT}$ can be factored out of the matrix element.
The exponential operator is split into position and momentum pieces using the Baker-Campbell-Hausdorff theorem,
$ e^{-\Delta t [\op{p}^2+V(\op{x})]} = e^{-\Delta t V(\op{x})}e^{-\Delta t \op{p}^2} +\order(\Delta t^2)$.
The position and momentum operators then acquire the eigenvalues from operating to the left and right respectively.
After carrying out the Gaussian momentum integrals, the matrix element is 
\begin{align}
  M %  &= \int \prod_{k=0}^{N-1}\frac{d\vect{x}_{k}d\vect{p}_k}{(2\pi)^{D}}
  % \prod_{j=1}^{N} e^{-\Delta t\left[\vect{p}_k^2/2 + V(\vect{x}_k,t_k)\right]+i\vect{p}_k\cdot(\vect{x}_{k+1}-\vect{x}_k)}
  % f(\vect{x}_0,0)\\
&= e^{-\lambda t}\int \prod_{k=0}^{N-1}\frac{d\vect{x}_{k}}{(2\pi\Delta t)^{D/2}}
  \prod_{j=1}^{N} e^{-(\vect{x}_{k+1}-\vect{x}_k)^2/(2\Delta t)-\Delta t V(\vect{x}_k)}f(\vect{x}_0,0)
\end{align}
This is the traditional discrete form of the Euclidean path integral.
We can transform it to stressing the connection to Brownian motion by changing integration variables.
The vector Wiener increments are defined as $\Delta \vect{W}_k := \vect{x}_{N-k-1}-\vect{x}_{N-k}$. 
Note that this labeling is backwards in time from the usual convention, but it 
ensures that the solutions are defined in reference to the final coordinate $\vect{x}_N$.
A general point along the path is given by 
% This labelling convention ensures that 
% Then we can write the positions in terms of the Brownian motion
% $\sum_{k=0}^{j}\Delta \vect{W}_k = \vect{x}_{N-j}-\vect{x}_N$.
% Note that evaluate the solutions at a constant fixed position $\vect{x}_N=\vect{x}_f$
% So our coordinates should be defined relative to that point, which prompts defining
\begin{equation}
%  \sum_{k=0}^{j} \Delta \vect{W}_k = \vect{x}_{N-j}-\vect{x}_N\rightarrow 
\vect{x}_j = \vect{x}_N+\sum_{k=0}^{N-j} \Delta \vect{W}_k= \vect{x}_N+\vect{W}_j
\end{equation}
where the Wiener process is defined as $\vect{W}_j:=\sum_{k=0}^{N-j} \Delta \vect{W_j}$.
In terms of the Wiener paths, the path integral is
\begin{align}
  M %  &= \int \prod_{k=0}^{N-1}\frac{d(\Delta \vect{W}_{k})}{(2\pi\Delta t)^{D/2}}
  % \prod_{j=1}^{N} e^{-(\Delta \vect{W}_{k})^2/(2\Delta t)-\Delta t V(\vect{x}_N+\sum_{j=0}^{N-k}\Delta \vect{W}_j,t_k)}
  % f\big(\vect{x}_N+\sum_{j=0}^{N-j}\Delta \vect{W}_j,0\big)\\
&= e^{-\lambda t}\int \prod_{k=0}^{N-1}d(\Delta \vect{W}_{k})
  \prod_{j=1}^{N} \frac{e^{-(\Delta \vect{W}_{j})^2/(2\Delta t)}}{(2\pi\Delta t)^{D/2}}e^{-\Delta t\, V(\vect{x}_N+\vect{W}_{N-j})}
  f[\vect{x}_N+\vect{W}_{N},0].
\end{align}
After taking the continuum limit $N\rightarrow\infty$, 
the Wiener paths $\vect{W}_k=\vect{W}(t_k)$ become a continuously varying stochastic processes, and
the sum over potentials $V(x_j)$ can be written as an integral,
\begin{align}
  M  &= \biggdlangle \exp\bigg(-\lambda t-\int_0^t du\, V[\vect{x}+\vect{W}(t-u)]\bigg) f(\vect{x}+\vect{W}(t),0)\biggdrangle
\end{align}
The same style of reasoning can be used for both terms in Eq.~(\ref{eq:op_soln}). 
After substituting this result in to Eq.~(\ref{eq:op_soln}), the solution to the diffusion equation is 
\begin{align}
  f(\vect{x},t) = &\biggdlangle  f[\vect{x}+\vect{W}(t),0]\exp\bigg(-\lambda t -\int_0^t du\, V[\vect{x}+\vect{W}(t-u)]\bigg)\biggdrangle\nonumber\\
  &+\int_0^t ds\,\biggdlangle  g[\vect{x}+\vect{W}(s),s]\exp\bigg(-\lambda s -\int_0^s du\, V[\vect{x}+\vect{W}(s-u)]\bigg)\biggdrangle.
  \label{eq:feynman-kac}
\end{align}
This agrees with the results of the more formal methods presented in Durrett~\cite{Durrett1996}, and Steck~\cite{SteckNotes}.
This result was derived under the assumption that the potential is independent of time, since that is 
all that is needed in worldline path integrals.  

\subsection{Steady-State Brownian Bridge Path Integral}

In worldline path integrals such as Eq.~(\ref{eq:TE_worldline}), the Brownian motions are pinned to close on themselves.
The solution to the diffusion equation~(\ref{label:eq:feynman-kac}) can be converted into the right form with some manipulation.
We will follow a solution method used by Hooghiemstra to compute the ``sojourn time''\footnote{
The sojourn time $T_\text{S}$
is the amount of time a Brownian process spends on one side of an interface at $x=d$,
$T_\text{S}:= \int_0^T dt\,\Theta[x(t)-d],$ where $\Theta$ is the Heaviside step function.}~\cite{
Hooghiemstra2002}.
This method is explained in detail by Steck in \S 17.9 -- \S 17.11~\cite{SteckNotes}.

First, take the steady-state limit where $t\rightarrow\infty$.
In this limit the initial condition is irrelevant so it can be set to zero.
Second, the source function $g$ can be used to construct the path pinning by setting $g(\vect{x})=\delta(\vect{x}-\vect{c})$.
After those manipulations, the general solution is
\begin{align}
  f(\vect{x}) = \int_0^{\infty} ds\,
  \biggdlangle \delta[\vect{x}+\vect{W}(s)-\vect{c}] \exp\bigg(-\lambda s -\int_0^s du\, V[\vect{x}+\vect{W}(s-u)]\bigg)\biggdrangle,
  \label{eq:f_soln}
\end{align}
which has the form of a Laplace transform in $\lambda$.  
The $\delta$-function selects paths that satisfy $\vect{W}(s)=\vect{c-x}$. In order to select
out Brownian paths starting from $\vect{x}=0$ and propagating to $\vect{x}=\vect{c}$, we should 
consider the solution at the origin $f(\vect{x}=0)$.  
The path integral (\ref{eq:f_soln}) satisfies the following steady-state diffusion equation
\begin{equation}
  0 = \frac{1}{2}\nabla^2f(x) - [V(\vect{x})+\lambda]f + \delta(\vect{x}-\vect{c}),\label{eq:diffusion_eq}
\end{equation}
which for simple geometries can be solved analytically.  The closed form for the path
integral is then found by inverting the Laplace transform in Eq.~(\ref{eq:f_soln}).
While the worldline path integral requires closed paths where $\vect{c}=0$, 
these path integral expressions will also be used for analytical expressions between
 positions along a given path.  
 The path integral results for sub-paths between one discrete position $\vect{x}_{k}$ to 
another $\vect{x}_{k+1}$ can be found by subtracting $\vect{x}_k$ from all coordinates in the problem
 so that $\vect{x}_k=0$, and $\vect{c}=\vect{x}_{k+1}-\vect{x}_k$.  This is particularly useful 
in applying these results to accelerating numerical computations, as will be discussed further in Ch.~\ref{ch:numerical}.

It might seem circular having passed from wave equations that are too hard to solve, to path integrals,
and back to diffusion equations we can only solve in particular geometries.
However, the path integral provides a way to chain together results from a simpler geometry to simulate
a more complicated geometry.
For example, at each step of the path, planar results could be used, by treating the bodies in terms of the
nearest tangent planes.  
%notion of locally planar could be defined in terms of the nearest surface-normal.  
This is not the same approximation as the proximity force approximation, 
which approximates the bodies \emph{globally} by the tangent planes.
This is a local approximation based on a particular point in space, 
and varies as the path moves through space.


% An analytical form for the path integral can be derived in conjunction with the diffusion equation.  
% In what may seem like circular logic, the diffusion equation can be solved, and by 
% the Feynman--Kac formula that solution is an analytical expression for a path integral.  
% These results from simple planar geometries form a possible basis for more complicated geometries,
% since they can be chained together in a spatially dependent manner.  


    The remainder of this chapter is devoted to solving the diffusion equation~(\ref{eq:diffusion_eq})
    for some simple planar geometries.
    These geometries are important for analytically calculating Casimir and Casimir--Polder
    energies from the worldline path integrals.  
    
\section{Single Step Potential}

As a first example, consider a step potential $V=\chi\Theta(x-d)$, where $\Theta(x)$ is the Heaviside step
function.  The Heaviside step function $\Theta(x)$ is unity for positive arguments, zero for negative arguments 
and takes a value of $1/2$ at the origin.
The step potential will be used to compute the Casimir--Polder energy for an atom 
above a dielectric half-space.
% It is also related to the Sojourn time statistic, which measures the time a Brownian motion $x(t)$ spends 
% beyond a certain point $d$,
% (The following is a much briefer discussion of the sojourn time, 
% which is discussed for various Brownian motions by Hooghiemstra who used the procedure 
% we follow~\cite{Hooghiemstra2002}.  Hooghiemstra's derivation is expanded and discussed in more detail
% in \S17.10 of Steck~\cite{SteckNotes}.)
Throughout what follows, we will work in one spatial dimension.  
In this work we will use an explicit $\delta$-function, rather than a Fourier representation as used by
Hooghiemstra.
In this case, $f$ solves
\begin{equation}
  0 = \frac{1}{2}\partial_x^2 f - [\chi\Theta(x-d)+\lambda]f + \delta(x).
\end{equation}
In general the solutions are of the form, 
\begin{equation}
  f(x) = A e^{\kappa x} + B e^{-\kappa x},
\end{equation}
where $\kappa$ will be determined to satisfy the differential equation in each region, and $A$ and $B$ will be determined by 
the matching conditions at the discontinuities.
The matching conditions follow from integrating the diffusion equation across the relevant discontinuity.  
At step discontinuities (such as at $x=d$), the solution and its derivative must be continuous across the surface,
    \begin{equation}
      \partial_xf(d+0_+) - \partial_x f(d-0_+) = 0, \qquad f(d+0_+)-f(d-0_+) = 0,  \label{eq:step_BC}
    \end{equation}
    where $0_+$ is a small positive real number.
At a $\delta$-function singularity the derivative of the solution is discontinuous, but the function
is continuous.
    \begin{equation}
      \partial_xf(0_+) -\partial_x f(-0_+) = -2 , \qquad f(d+0_+)-f(d-0_+) = 0.\label{eq:delta_BC}
    \end{equation}
    Then assuming $d>0$, taking the bounded solution in each region, the solution is 
\begin{equation}
  f(x) =\left\{ 
    \begin{array}{lcr}  A e^{\sqrt{2\lambda} x} & \hspace{2cm} & x<0\\
      B e^{\sqrt{2\lambda}x} + Ce^{-\sqrt{2\lambda}x} & \hspace{2cm} & 0<x<d\\
      D e^{-\sqrt{2(\lambda+\chi)}x} & \hspace{2cm} & x>d
    \end{array}
  \right.
.
\end{equation}
The coefficients are determined by applying the boundary conditions at the interfaces at $x=0$ and $x=d$. 
This was done using Mathematica to speed up the tedious algebraic work.  
The worldline path integral solution only requires $f(x=0)$, so only $A$ needs to be found.  
It is given by 
\begin{equation}
  A = \frac{1}{\sqrt{2\lambda}} - u\supTE\,e^{-2\sqrt{2\lambda}d},
\end{equation}
where
\begin{equation}
  u\supTE = \frac{\sqrt{\lambda} -\sqrt{\lambda+\chi}}{\sqrt{\lambda} + \sqrt{\lambda+\chi}}.
\end{equation}
The reflection coefficient $u\supTE$ plays the same role as the TE-reflection coefficients in the Lifshitz 
formula.  
A similar computation can be carried out for $d<0$, which corresponds to finding the solution inside
the medium.
For $d<0$, can get similar result from $D$, if $\lambda \leftrightarrow \lambda+\chi$.
The solution for both cases is
\begin{equation}
  f_{\scriptscriptstyle{\text{TE}},1}(x) = \left\{\begin{array}{lcr} 
      \dfrac{1}{\sqrt{2\lambda}}\left[1+ u\supTE\, e^{-2\sqrt{2\lambda}d}\right]  & \hspace{2cm} & d<0\\
      \dfrac{1}{\sqrt{2(\lambda+\chi)}}\left[1 - u\supTE\, e^{-2\sqrt{2(\lambda+\chi)}d}\right] & \hspace{2cm} & d>0\\
    \end{array} \right. 
.
\end{equation}
The subscript denotes the relevance of this solution to a single body in the TE polarization.  
Ultimately, we need to relate the solution to the diffusion equation back to the path integral via
\begin{equation}
 f\subTE= \int_0^\infty d\cT e^{-\lambda \cT} \biggdlangle \delta(x)e^{-\chi \theta[x(\cT)-d]}\biggdrangle_{W(t)}  
 = \int_0^\infty d\cT e^{-\lambda \cT} \biggdlangle \frac{e^{-\chi \int_0^\cT dt\,\theta[x(\cT)-d]}}{\sqrt{2\pi \cT}}\biggdrangle_{x(\cT)}  
  \label{eq:Feynman-Kac TE one step}
\end{equation}
where the first ensemble average is over free Wiener paths, while the second is over Brownian bridges that satisfy $x(0)=x(\cT)=0$.
The factor of $(2\pi \cT)^{-1/2}$ is the normalization for using closed Brownian bridges.  
In this case, we will not undo the Laplace transform, since later results can convert the relevant 
Casimir energies to exploit this form of the energy. 

It is possible to generalize this calculation to compute the equivalent formulae for open Brownian
bridges from $0\rightarrow c$, as discussed in App. B of Ref.~\cite{Mackrory2016}.
These formulae may be useful in accelerating numerical techniques, with relatively coarse bridges.
However the formulae are quite complicated and involve diverging integrands, which makes it difficult to implement them 
efficient.


\subsection{Planar Dirichlet Conditions}

It is possible to take the strong-coupling limit where $\chi\rightarrow \infty$. 
In that Dirichlet limit, the reflection coefficient goes to negative one, and the solution vanishes on the surface.
The path integral solution is
\begin{equation}
  f_{D,1}(x) = \left\{\begin{array}{lcr} 
      \dfrac{1}{\sqrt{2\lambda}}\left[1 - e^{-2\sqrt{2\lambda}d}\right]  & \hspace{2cm} & d<0\\
      0 & \hspace{2cm} & d>0\\
    \end{array} \right. 
\end{equation}
This result can straightforwardly be generalized to open Brownian bridges for paths between $x$ and $y$, and a surface at $d$.
The path integral can be converted back to the time domain by inverting the Laplace transform with
\begin{equation}
  \mathcal{L}^{-1}\bigg(\frac{1}{\sqrt{2\lambda}}e^{-2\sqrt{2\lambda}d}\bigg) 
  = \frac{1}{\sqrt{2\pi t}}e^{-d^2/(2t)}.\label{eq:Laplace_Gaussian}
\end{equation}
The result is
\begin{equation}
  f_{D,1}(x,y) = \left\{\begin{array}{lcr} 
      \dfrac{e^{-(x-y)^2/(2t)}}{\sqrt{2\pi t}}\left[1 - e^{-2(d-x)(d-y)/t}\right]  & \hspace{0.5cm} & (x-d)(y-d)>0\\
      0 & \hspace{0.5cm} & (x-d)(y-d)<0\\
    \end{array} \right. 
\end{equation}
The lower solution applies when $x$ and $y$ are on different sides of the surface and the path 
must cross through.  The upper solution applies when the points are both on the same side.
As the points $x$ and $y$ get closer to the surface, the probability of touching the surface increases, 
and the amplitude of the solution decreases.

This analytical could be applied to enhance Dirichlet worldline methods with little cost,
since path resolution is one of the dominant sources of error in numerical worldlines~\cite{Mackrory2016}.

\section{Two Step Potentials}

The next case of importance is for two step potentials, where $V=\chi_1\Theta[d_1-x]+\chi_2\Theta[x-d_2]$.
The bodies are separated by a distance $d=d_2-d_1$.
This potential is useful for analytically calculating the Casimir energy between two dielectric half-spaces,
or the Casimir--Polder energy for an atom between two half-spaces.
The same procedure as a single half-space can be used, albeit with another set of boundary conditions to manage.   
The solution and its derivative must be continuous at both surfaces.

Skipping what is some tedious algebra, the solution for closed Brownian paths can be be written 
in each of three regions: Region I is inside the left hand body with $x_0<d_1$, Region II is 
between the bodies with $d_1<x_0<d_2$, and Region III is inside the right hand body with $d_2<x_0$.
The reflection coefficients for each body are given by 
\begin{equation}
  u\supTE_i = \frac{\sqrt{\lambda} -\sqrt{\lambda+\chi_i}}{\sqrt{\lambda} + \sqrt{\lambda+\chi_i}}.
\end{equation}
The solutions for each region are 
 \begin{subequations}
  \label{eq:Feynman-Kac TE two step}
 \begin{align}
  f_{\text{TE},12}^{(I)}(x_0)&= \dfrac{1}{\sqrt{2(\lambda+\chi_1)}} 
  + e^{-2\sqrt{2(\lambda+\chi_1)}(d_1-x_0)}\dfrac{u\supTE_2 e^{-2\sqrt{2\lambda}d} - u\supTE_1}
  {\sqrt{2(\lambda+\chi_1)}(1-u\supTE_1u\supTE_2 e^{-2\sqrt{2\lambda}d})}\\
  f^{(II)}_{\text{TE},12}(x_0)&=\frac{1}{\sqrt{2\lambda}} 
  + \dfrac{2u\supTE_1u\supTE_2 e^{-2\sqrt{2\lambda}d} + u\supTE_1 e^{2\sqrt{2\lambda}(d_1-x_0)} 
    +u\supTE_2 e^{-2\sqrt{2\lambda}(d_2-x_0)}}{\sqrt{2\lambda}(1-u\supTE_1u\supTE_2 e^{-2\sqrt{2\lambda}d})}\\
  f^{(III)}_{\text{TE},12}(x_0)& = 
  \dfrac{1}{\sqrt{2(\lambda+\chi_2)}} 
  + e^{2\sqrt{2(\lambda+\chi_2)}(d_2-x_0)}\dfrac{(u\supTE_1 e^{-2\sqrt{2\lambda}d}-u\supTE_2)}
  {\sqrt{2(\lambda+\chi_2)}(1-u\supTE_1u\supTE_2 e^{-2\sqrt{2\lambda}d})}.
\end{align}
\end{subequations}
The ``12'' subscript denotes that both left and right or first and second bodies are present.
The equivalent single body expressions can be derived from these.  For example, the solution for body 1 can
be found by keeping $d_1$ fixed, but setting $d=d_2$ to infinity.  

Note the presence of $1-u\supTE_1u\supTE_2e^{-2\sqrt{2\lambda}d}$ in the denominators.  Given we are solving essentially the same
problem as when we derived the Lifshitz formula in Sec.~\ref{sec:lifshitz}, this is perhaps not surprising. 
However, in this case there is no need to make any conditions on which modes contribute.  
Later we will convert the worldline energy into a suitable form to use these results as written.  

We will not attempt to invert the Laplace transform to find the solution in the time domain.
In the strong coupling ($u\supTE_i\rightarrow -1$) limit, 
the Laplace transform can be inverted by expanding the denominator using 
$(1-e^{-2\sqrt{2\lambda}d})^{-1}=\sum_{n}(-1)^n e^{-2n\sqrt{2\lambda}d}$ since $e^{-2\sqrt{2\lambda}d}<1$.  
The $n^{\text{th}}$ order term corresponds to the $n^\text{th}$ reflection
from the far surface.
After inverting the Laplace transforms, each Gaussian in the sum would be of the form $\exp[-2(n+1)^2d^2/t]$, corresponding
to the probability for a Brownian path to bounce $n$ times between points a distance $d$ apart.
This naturally goes over to the reflection picture for the Dirichlet scalar discussed in \S21.1.5.3 of Steck~\cite{SteckNotes}.

\section{Feynman--Kac formula for Singular Potentials}
\label{sec:TM_potential}
The same methods can be used to yield sensible, finite results for worldline path integrals
involving singular potentials, such as $V\subTE$ and $V\subTM$ where
\begin{equation}
  V\subTM(x) = \frac{1}{2}\big[(\partial_x\log\sqrt{\epsilon})^2-\partial_x^2\log\sqrt{\epsilon}\big].
\end{equation}
(We will focus on $V\subTM$, since $\mu=1$ for almost all materials, so $V\subTE=0$.)
For a dielectric with a step-function discontinuity $\epsr = 1+\chi\Theta(x-d)$, the resulting
potential is highly singular.  
The first derivative of a step-function is a $\delta$-function, and 
the second derivative is $\delta'$.  We define a parameter $\Xi:=\log\sqrt{1+\chi}$, which means
$\log\sqrt{\epsr}(x) = \Xi\theta(x-d)$, and the potential is given by
\begin{equation}
  V\subTM(x) \sim \frac{1}{2}\big[\Xi^2\delta^2(x-d)-\Xi \delta'(x-d)\big].
\end{equation}
The only way to make sense of this is to regularize the singularity in the step-function,
and take the limit of vanishing regularization at the end of the computation. 

We will consider an exponential interpolation of the dielectric between the two values $1$ and $1+\chi$,
over a distance $a$,
\begin{equation}
  \epsr\supa(x)= \left\{\begin{array}{ccr} 
      1 & \hspace{0.5cm} &x<d\\ 
      e^{2\Xi (x-d)/a} & \hspace{0.5cm}&d<x<d+a\\
      1+\chi & \hspace{0.5cm}&x>d+a
    \end{array}.
  \right.
\end{equation}
% \begin{equation}
%   \epsr\supa(x)= \Theta(d-x) + \Theta(x-d)\Theta(d+a-x)e^{2\Xi (x-d)/a} + \Theta(x-d-a)(1+\chi)
%   %     1 & \hspace{0.5cm} &x<d\\ 
%   %     e^{2\Xi (x-d)/a} & \hspace{0.5cm}&d<x<d+a\\
%   %     1+\chi & \hspace{0.5cm}&x>d+a
%   %   \end{array}.
%   % \right.
% \end{equation}
The logarithm of the dielectric can then be written
\begin{equation}
  \log\sqrt{\epsr\supa}(x)  
= \left\{\begin{array}{ccr} 
      0 & \hspace{0.5cm} &x<d\\ 
      \frac{\Xi}{a}(x-d)& \hspace{0.5cm}&d<x<d+a\\
      \Xi & \hspace{0.5cm}&x>d+a
    \end{array}.
  \right.
\end{equation}
The regularized TM potential is now given by 
\begin{equation}
  V\subTM\supa(x) = \frac{\Xi^2}{2a^2}\Theta(x-d)\Theta(d+a-x)-\frac{\Xi}{a}[\delta(x-d)-\delta(x-d-a)\big].
\end{equation}
The worst singularity present are the $\delta$-functions from the second derivative.
The potential is still quite singular, and cannot be handled nicely for just a single path, the ensemble
averaged expression over many such paths is well behaved.  % And that ensemble averaged expression can be
% found by solving the associated diffusion equation.  Fortunately, this is smooth enough to get sensible results.

\begin{figure}
  \centering
  \includegraphics[width=0.4\linewidth,angle=90]{fig/analytical/TMpot}
  \caption[Regularized TM Potential]{Schematic drawing of a regularized TM potential at a surface. 
    Vertical arrows denote $\delta$-functions.}
\end{figure}

% \begin{enumerate}
%   % \item Smooth out contribution by analytically averaging over subpaths.
%   %   In handling the TM case we will first have need to handle that singular potential.
%   % \item We shall do this first on it's own, since we will have to use those results in any numerical method.
%   %   In addition, it vastly simplifies down.
%   %   We will find that the potential enforces a boundary condition.  

%   \item Quote PDE, and exact form of the potential
%     We will find the solution to 
%     \begin{equation}
%       \partial_t f = \frac{1}{2}\partial_x^2f -V_{TM} f - \lambda f + \delta(x-c)
%     \end{equation}
%     where 
% \end{enumerate}

\subsection{Transfer Layer Boundary conditions for TM Potential}

We will show that the regularized TM potential imposes an effective boundary condition at the interface. 
The diffusion equation can be solved inside the boundary layer $x\in(d,d+a)$, and all references 
to the interior can be eliminated.  The result of this will be conditions relating
the solution and its derivatives on either side of the surface.
Points starting inside the surface will not be considered, since the surface is infinitesimally thin.

The analytical solutions for the path integral obey
\begin{equation}
  \frac{1}{2}\partial_x^2f =\frac{1}{2}\bigg[\lambda+\frac{\Xi^2}{a^2}\Theta(x-d)\Theta(d+a-x)
  - \frac{\Xi}{a}[\delta(x-d)-\delta(x-d-a)]\bigg]f
\end{equation}
Since $a$ is small, $\Xi/a$ is large relative to $\lambda$, so $\lambda$ which can be ignored in the thin-surface limit.    
At $x=d$, and $x=d+a$, $\delta$-function matching conditions~(\ref{eq:delta_BC}) will be enforced.

Let $f_{\text{mid}}$ be the solution in the middle region for $x\in(d,d+a)$,   
    \begin{align}
      f_{\text{mid}} %=& Be^{\sqrt{2\lambda + \Xi^2/a^2}x} + C e^{-\sqrt{2\lambda + \Xi^2/a^2}x}\\
      =& Be^{\Xi x/a} + C e^{-\Xi x/a}.
    \end{align}
%    Our goal is to derive the effective conditions imposed on the solutions just outside the surface.
    Let the solutions from the left be $f_1:=f(d-0_+)$, and the gradient $\partial_x f_1:=\partial_x f(d-0_+)$,
    with corresponding solutions on the right $f_2:=f(d+a+0_+)$, $\partial_x f_2:=f(d+a+0_+)$.  As far as this 
    calculation is concerned, these are unspecified real constants. 
    The continuity conditions at $x=d$ and $x=d+a$ require that
    \begin{subequations}
      \begin{align}
        f_{\text{mid}}(d)-f_1 &= 0 \label{eq:f1}\\
        f_2- f_{\text{mid}}(d+a)&= 0 \label{eq:f2}\\
        f_{\text{mid}}'(d) -f_1'&= -\frac{\Xi}{a} f_1\label{eq:f1'}\\
        \partial_x f_2 -\partial_x f_{\text{mid}}(d+a)&= +\frac{\Xi}{a} f_2.\label{eq:f2'}
      \end{align}
    \end{subequations}
   These equations can be solved for the internal parameters $B$ and $C$, as well as two of the external 
   parameters, $f_2$ and $\partial_x f_2$.  As a result, there will be simple effective boundary conditions between
   the field values on either side of the boundary layer.  
   Given this calculation's importance to our subsequent work, we will actually go through the elementary algebra.  

   % Find relations between $f(d\pm \epsilon)$ and $f'(d\pm \epsilon)$.
   %  We will solve for $f(d+a+\epsilon)$, and $f'(d+a+\epsilon)$,
   %  trying to eliminate $B$ and $C$, which we will fix in terms of $f(d-\epsilon),f'(d-\epsilon)$.
   %  We will thus have derived the relation between $f$ and its derivatives on both sides of the potential.      
    The continuity conditions in Eqs.~(\ref{eq:f1}) and (\ref{eq:f2}) require that
    \begin{align}
%      f(d+\epsilon) - f(d-\epsilon) =& 0\\
%      \rightarrow 
      f_1 &= Be^{\Xi d/a} + C e^{-\Xi d/a}\label{eq:M c1}\\
    % \end{align}
    % Similarly, at the second edge  we find that 
    % \begin{align}
    %   f(d+a+\epsilon) - f(d+a-\epsilon) =& 0\\
    %   \rightarrow 
      f_2 &= Be^{\Xi d/a+\Xi} + C e^{-\Xi d/a-\Xi}\label{eq:M c2}.
    \end{align}
    The derivative conditions in Eqs.~(\ref{eq:f1'}) and (\ref{eq:f2'}) then require that
    \begin{align}
%      f'(d +\epsilon)-f'(d-\epsilon) =& -\frac{\Xi}{a}f(d)\\
%      \rightarrow f'_1%=& \frac{\Xi}{a}\left(Be^{\Xi d/a} + C e^{-\Xi d/a}\right) + \frac{\Xi}{a}\left(Be^{\Xi d/a} - C e^{-\Xi d/a}\right)\\
      \partial_xf_1&= 2\frac{\Xi}{a}Be^{\Xi d/a} \label{eq:M d1}\\
    % \end{align}
    % And the derivative conditions at $d+a$ yield 
    % \begin{align}
       % f'(d+a+\epsilon) -f'(d+a-\epsilon)=& \frac{\Xi}{a}f(d+a)\\
      % \rightarrow f'(d+a+\epsilon)=&\frac{\Xi}{a}\left(Be^{\Xi (d+a)/a} + C e^{-\Xi (d+a)/a} \right)+ \frac{\Xi}{a}\left(Be^{\Xi (d+a)/a} - C e^{-\Xi (d+a)/a} \right)\\
      \partial_xf_2&=2\frac{\Xi}{a}Be^{\Xi d/a}e^{\Xi}\label{eq:M d2}
    \end{align}
    From the derivative conditions, $\partial_xf_1$ and $\partial_xf_2$ can be related to one another as follows
%    Eq.~(\ref{eq:M d1}) fixes $B$, which we can use in to Eq.~(\ref{eq:M d2}), so that 
    \begin{equation}
      \partial_xf_2 = e^{\Xi}\partial_xf_1.
    \end{equation}
    In addition, under the assumption that the external gradients $\partial_x f_1$, $\partial_xf_2$ are independent of $a$ and order one,
    that also implies that $B\sim\order(a)$.  That implies that in the continuity conditions 
    $B$ can be dropped relative to $C$ which must also be order one.  On setting $B=0$, it is clear 
    from Eqs.~(\ref{eq:M c1})-(\ref{eq:M c2}) that 
% Next up the normal continuity condition.  
%     \begin{align}
%       f_1 =& B e^{\Xi d/a} + C e^{-\Xi d/a}\\
%       =& \frac{a}{2\Xi} f' + C e^{-\Xi d/a} = C e^{-\Xi d/a},
%     \end{align}
%     which says that $B\sim a$, so we will drop it from this part of the calculation.  
%     Now use this in Eq.~(\ref{eq:M d2}) to find
    \begin{equation}
      f_2 =  e^{-\Xi} f_1.  
    \end{equation}
    At this point, the conditions between the solutions outside the boundary layer have been derived,
    and the  $a\rightarrow 0$ limit can be taken everywhere.  
    The regularized dielectric step produces the following effective boundary matching conditions at an interface
    \begin{align}
      \Aboxed{
        f(d+0_+) =& e^{-\Xi}f(d-0_+), \qquad
        \partial_xf(d+0_+)= e^{\Xi}\partial_xf(d-0_+)
      }\label{eq:TM_boundary_conditions}
    \end{align}
    \label{sec:TM boundary condition}
    These boundary conditions can then be used to find the ensemble average solution.  

\subsection{Finding the Path Integral Solution for the TM Potential}

% We can now find the Feynman--Kac formula for open Brownian bridges near a single TM-potential, which 
% imposes the boundary conditions~\ref{eq:TM_boundary_conditions}.  This solution is the ensemble average 
% over all Brownian paths between the end points.

We aim to find a closed form solution for the path integral over paths between starting at $x=0$ and terminating at $c$ after time $t$ and 
interacting with potential $V\subTM$,
\begin{equation}
  f\subTM(c,d,\Xi)=\int_0^\infty dt\, e^{-\lambda t}\frac{e^{-c^2/(2t)}}{\sqrt{2\pi t}} \dlangle e^{-\int_0^T dt V_{TM}}\drangle.
\end{equation}
The Gaussian factor in $c$ is the normalization for a 1D Brownian bridge between $x=0$ and $c$ in time $t$.
This path integral is found by solving
\begin{equation}
  0 = \frac{1}{2} \partial_x^2 f\subTM - (V\subTM+\lambda)f\subTM + \delta(x-c),
\end{equation}
where TM boundary conditions~(\ref{eq:TM_boundary_conditions}) are imposed at $x=d$,
and $\delta$-function boundary conditions~(\ref{eq:delta_BC}) are imposed at $x=c$.  
The solutions naturally decompose into two cases: first,  when the end points of the path are on the same
side of the surface,  and when they are on different sides.
% \comment{    Note how to recover various cases by flipping signs etc.  
%     Simplify down to crossing/no-crossing cases.}
%    That seems complicated, but we can note that if there is a crossing ($|c|<|d|$) then we get 
    When both points are on the same side, or $d(d-c)>0$, the solution is 
    \begin{equation}
      f\subTM=\dfrac{e^{-\sqrt{2\lambda}|c|}}{\sqrt{2\lambda}} 
      + \sgn(d)\dfrac{e^{-\sqrt{2\lambda}|2d-c|}}{\sqrt{2\lambda}}\dfrac{e^{2\Xi}-1}{e^{2\Xi} +1},
    \end{equation}
    where $\sgn(x)$ is the signum function: $\sgn(0)=0$, $\sgn(x>0)=1$, $\sgn(x<0)=-1$.
    When the paths must cross through the surface since $x=0$ and $c$ are on different sides of the surface so $d(d-c)<0$,
    the solution is
    \begin{equation}
      f\subTM = \dfrac{ e^{-\sqrt{2\lambda}|c|}}{\sqrt{2\lambda}} \dfrac{2e^\Xi}{1 + e^{2\Xi}}.
    \end{equation}
    In both cases the Laplace transforms in $\lambda$ can be inverted yielding Gaussians [following from Eq.~(\ref{eq:Laplace_Gaussian})].
    After canceling out the Gaussian factor $e^{-c^2/(2t)}/\sqrt{2\pi t}$, the analytical expression for 
    the path integral can be isolated
    % Ultimately, we will want to isolate the potential term.  
    % If we use 
    % \begin{equation}
    %   \mathcal{L}^{-1}\left[ \frac{e^{-\sqrt{2\lambda}x}}{\sqrt{2\lambda}}   \right] = \frac{e^{-x^2/(2t)}}{\sqrt{2\pi t}},
    % \end{equation}
    % which is exactly the factor we isolated in front of $\mathcal{M}$.  
    \begin{align}
      \dlangle e^{-\int_0^t dt'\, V\subTM(x-d)}\drangle 
      &=\left\{ \begin{array}{lc} 
          1   + \sgn(d)\tanh\Xi\, e^{-2d(d-c)/t} & d(d-c)>0\\
          \sech\Xi & d(d-c)<0
        \end{array}
        \right.  \label{eq:TM_potential}
      \end{align}
      This result is absolutely crucial for developing numerical methods for the TM polarization.  
      Even the regularized potential is too unruly to handle on a single trajectory wise basis.  The analytical
      solution smooths the result out by averaging over all possible sub-paths. 
      The result can be extended to include any starting point $x_i$ by shifting $d\rightarrow d-x_i$,
      and identifying $c=x_f-x_i$, where $x_f$ is the final point.

      The potential has been plotted in Fig.~\ref{fig:TM_plot} as a function of ending point
      for paths starting inside and outside the barrier.  
      Note that the potential leads to larger values on the vacuum side of the medium, 
      and suppresses values for starting points inside the surface or paths that must cross the surface.  

      The material constants can be rewritten in terms of $\chi$,
      \begin{align}
        \tanh\Xi &=\dfrac{e^{2\Xi}-1}{e^{2\Xi} +1} =\dfrac{\chi}{2+\chi}=\frac{\epsilon_{\text{r},1} -1}{\epsilon_{\text{r},1}+1}\\
        \sech\Xi &= \dfrac{2e^\Xi}{1 + e^{2\Xi}} = \frac{2\sqrt{1+\chi}}{2+\chi}.
      \end{align}
      In the strong-coupling limit $\tanh\Xi\rightarrow 1, \sech\Xi\rightarrow 0$, and the solution for 
      paths starting at the origin is
    \begin{align}
      f_N      &=\theta[d(d-c)]\bigg( 1 +\sgn(d)\dfrac{e^{-2d(d-c)/t}}{\sqrt{2\pi t}}\bigg).
      \end{align}
      This is in some sense dual to the Dirichlet limit.  In that case paths reflect off with the opposite phase, 
      leading to a value of zero on the boundary.  Here, the paths reflecting off the surface add in phase, suggesting 
      a correspondence to Neumann boundary conditions.  However, this does not hold for paths starting 
      inside the surface, where the solution is the same as for Dirichlet boundary conditions.  

    \begin{figure}
      \hspace{2cm}
      PLOT OF TM SOLUTION
      \caption[Plot of TM Solution]{Plot of path-averaged TM solution for various ending points}
      \label{fig:TM_plot}
    \end{figure}
    

    % Dan has:
    % \begin{equation}
    %   \dlangle \exp\left[-\int_0^T dt V_{TM}(x-d)\right]\drangle = 1 + \frac{\sinh(\Xi/2)}{\cosh\Xi}[\sgn(d-c)e^{\sgn(d)\Xi/2} + \sgn(d)e^{-\sgn(d)\Xi/2}]e^{\left[c^2-(|d|+|c-d|)^2\right]/2t}.
    % \end{equation}
    % This agrees with my expressions for all cases.  This is useful for our numerical work.  
    % Let us check out the $\Xi$ prefactor against my work.  
    % \begin{align}
    %   F_{d>0,c<d} =&\frac{\sinh(\Xi/2)}{\cosh\Xi}[\sgn(d-c)e^{\sgn(d)\Xi/2} + \sgn(d)e^{-\sgn(d)\Xi/2}]\\
    %   =&\frac{\sinh(\Xi/2)}{\cosh\Xi}[e^{\Xi/2} + e^{-\Xi/2}] = \frac{e^{\Xi} - e^{-\Xi}}{e^\Xi+ e^\Xi}  
    % \end{align}
    % works.
    % \begin{align}
    %   F_{d>0,d<c} =&\frac{\sinh(\Xi/2)}{\cosh\Xi}[-e^{\Xi/2} + e^{-\Xi/2}] = -\frac{ e^{-\Xi} + e^{\Xi} -2}{e^\Xi + e^{-\Xi}},
    % \end{align}
    % works, 
    % \begin{align}
    %   F_{d<0,c<d} =\frac{\sinh(\Xi/2)}{\cosh\Xi}[e^{-\Xi/2} -e^{\Xi/2}]=\frac{[(e^{\Xi/2}- e^{-\Xi/2})(e^{-\Xi/2} -e^{\Xi/2})]}{e^\Xi + e^{-\Xi}}=-\frac{e^\Xi + e^{-\Xi} -2}{e^\Xi + e^{-\Xi}},
    % \end{align}
    % works, and 
    % \begin{align}
    %   F_{d<0,d<c} =&\frac{\sinh(\Xi/2)}{\cosh\Xi}[-e^{\Xi/2} -e^{-\Xi/2}] = -\frac{e^\Xi - e^{-\Xi}}{e^\Xi + e^{-\Xi}}
    % \end{align}

\section{Single TM potential and Step}

Next, we consider a dielectric step combined with a TM boundary condition.  
This is required to analytically compute the TM component of the Casimir--Polder energy for an atom near a
dielectric half-space.  We will only develop the solution for closed paths.
The path integral
    \begin{equation}
      f = \int_0^\infty dt\, e^{-\lambda t}\frac{1}{\sqrt{2\pi t}}\bigdlangle e^{-\int_0^t dt'\, [V\subTM(x,d) + \chi\Theta(x-d)]}\bigdrangle ,
    \end{equation}
    is the steady-state solution to 
    \begin{equation}
      \partial_t f = \frac{1}{2}\partial_x^2f -[V_{TM}(x,d) + \chi\Theta(x-d)+\lambda]f +\delta(x). 
    \end{equation}
    The analytical expression is found by solving the diffusion equation directly, with 
    TM boundary conditions~(\ref{eq:TM_boundary_conditions}) at $x=d$ and 
    $\delta$-function boundary conditions~(\ref{eq:delta_BC}) at $x=0$.
    The solution for a single TM body is 
  \begin{equation}
      f_{TM,1}(x) = \left\{\begin{array}{lcr} 
          \dfrac{1}{\sqrt{2\lambda}}\left[1+ u\supTM e^{-2\sqrt{2\lambda}d}\right]  & \hspace{2cm} & d<0\\
          \dfrac{1}{\sqrt{2(\lambda+\chi)}}\left[1 - u\supTM e^{-2\sqrt{2(\lambda+\chi)}d}\right] & \hspace{2cm} & d>0\\
        \end{array} \right. 
    \end{equation}
    where
    \begin{equation}
      u\supTM = \frac{\sqrt{\lambda}e^{2\Xi} -\sqrt{\lambda+\chi}}{\sqrt{\lambda}e^{2\Xi} + \sqrt{\lambda+\chi}}.
    \end{equation}
    The reflection coefficient $u\supTM$ corresponds to the TM reflection coefficient 
    used in Sec.~\ref{sec:lifshitz}, since $e^{2\Xi}=1+\chi$.  
    This calculation can also be naturally extended to include a magnetic response.
    The parameter $\Xi$ is defined in relation to the boundary condition, while $\chi$ relates to the 
    step discontinuity.  To describe the TM potential, one could take $\chi\rightarrow (\epsr\mur-1)$
    and $\Xi$ is unchanged.  Similar reasoning could apply these results to the TE potential,
    after the $\epsr\leftrightarrow \mur$ substitution is carried out.

    % Ultimately, we find that 
    % \begin{align}
    %   &\int_0^\infty dT e^{-\lambda T} \dlangle \frac{1}{\sqrt{2\pi T}}
    %   \exp\left(-\int_0^T dt \{V\subTM[x(t)]+s\theta[x(t)-d]\}\right)\drangle\nonumber\\
    %   &\hspace{1cm}=
    %   \frac{1}{\sqrt{2[\lambda+\chi\theta(d)]}}\left[1 - \sgn(d) u\supTM e^{-2\sqrt{2[\lambda+\chi\theta(d)]}|d|}\right]
    %   ,\label{eq:Feynman--Kac TM one step}
    % \end{align}
    % where the ensemble average is over brownian bridges that satisfy $x(0)=x(T)=0$.
    % The factor of $\sqrt{2\pi T}$ is normalization for the use of the bridges.  


\section{Two TM Step Potentials}

The preceding calculations for can be easily adapted to handle two planar half-spaces subject to 
TM boundary conditions. This time consider the path integral solution for a potential
\begin{equation}
  V = \chi_1\Theta(-d/2-x)+\chi_2\Theta(x-d/2)+V\subTM(-\Xi_1,-d/2)+V\subTM(\Xi_2,d/2)
\end{equation}
In this case a little care is needed in defined the boundary conditions at the left hand surface.
Since the left body has the opposite orientation (the permittivity decreases at $x=-d/2$)
the correct TM potential for the left body has $Xi\rightarrow-\Xi_1$ everywhere.
This change reverses the nature of the effective boundary conditions at the surface: if passing 
through the surface decreases the function, and increases the gradient, then traversing the surface in the   
opposite direction should have the opposite effect.  

  % \item {Quote full potential, and note boundary conditions.}
  % \item Quote full potential, and PDE.
  % \item Comment on how to handle other surface.
  %   When we do the Casimir energy between two bodies we will need to find the Feynman--Kac formula assuming two step discontinuities.
  %   We will use exactly the same procedure as above, but with an extra step. 

  %   The potential is then 
  %   \begin{equation}
  %     V = \chi_1\Theta(h-x) + \chi_2\Theta(x-h-d) + \mathfrak{M}(-\Xi,h) + \mathfrak{M}(\Xi,h+d),
  %   \end{equation}
  %   where we took $\Xi \rightarrow -\Xi$ on one step since $\partial^2_x\theta(-x) = -\delta'$.  
  % \item Exploit symmetry of effective boundary conditions.  
  % \item {Quote results.  Note that $r\rightarrow r'$.}

%     We then need to solve this for the various cases of $h,h+d $ on each side of $x=0$:
%     \begin{equation}
%       f_{TM,12}[x-(h-x_0)] = \left\{ \begin{array}{ccr}
%           \dfrac{1}{\sqrt{2(\lambda+\chi_1)}} + e^{-2\sqrt{2(\lambda+\chi_1)}(h-x_0)}
% \dfrac{u\supTM_2 e^{-2\sqrt{2\lambda}d} - u\supTM_1}{\sqrt{2(\lambda+\chi_1)}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})} & \hspace{1cm} & h>x_0\\
%           \frac{1}{\sqrt{2\lambda}} + 
%           \dfrac{2u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d} + u\supTM_1 e^{2\sqrt{2\lambda}(h-x_0)} +u\supTM_2 e^{-2\sqrt{2\lambda}(d+h-x_0)}}
%           {\sqrt{2\lambda}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})} & \hspace{1cm} & h<x_0<h+d\\
%           \dfrac{1}{\sqrt{2(\lambda+\chi_2)}} + e^{2\sqrt{2(\lambda+\chi_2)}(d+(h-x_0))}
%           \dfrac{(u\supTM_1 e^{-2\sqrt{2\lambda}d}-u\supTM_2)}{\sqrt{2(\lambda+\chi_2)}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})} & \hspace{1cm} & h+d<x_0
%         \end{array}
%       \right.
%     \end{equation}
%     \item {Quote various limits for $h,h+d$ on either side of 0}
The resulting solutions have the same form and structure as the TE solutions, but with 
the TE reflection coefficients replaced by their TM counterparts.  
% (This simple correspondence was not anticipated given the highly singular form of the TM potentials.  
% Only the regularization, and the analytical averaging over sub-paths allowed this simplicity to emerge.)
The two-body TM solution can be written in the same three regions as two-body TE solution:%  where 
% For paths starting in the left body, $x_0<d_1$ the solution is
\begin{subequations}
    \begin{align}
      f^{(\text{I})}\subTMtwo(x) &=
           \dfrac{1}{\sqrt{2(\lambda+\chi_1)}} + \frac{e^{-2\sqrt{2(\lambda+\chi_1)}(d_1-x_0)}}{\sqrt{2(\lambda+\chi_1)}}
 \dfrac{u\supTM_2 e^{-2\sqrt{2\lambda}d} - u\supTM_1}{1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d}}\\
% =\frac{1}{\sqrt{2(\lambda+\chi_1)}} + e^{-2\sqrt{2(\lambda+\chi_1)}(d_1-x_0)}
%       \frac{u\supTM_2 e^{-2\sqrt{2\lambda}d}-u\supTM_1 }{\sqrt{2(\lambda+\chi_1)}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})}.
%    \end{align}
    % For paths starting in the middle, $d_1<x_0<d_2$, the solution is
    % \begin{equation}
      f^{(\text{II})}\subTMtwo(x)&= %= \frac{1}{\sqrt{2\lambda}} + \frac{2u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d} + u\supTM_1 e^{2\sqrt{2\lambda}h} +u\supTM_2 e^{-2\sqrt{2\lambda}(d+h)}}{\sqrt{2\lambda}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})}
          \frac{1}{\sqrt{2\lambda}} + 
          \dfrac{2u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d} + u\supTM_1 e^{2\sqrt{2\lambda}(d_1-x_0)} +u\supTM_2 e^{-2\sqrt{2\lambda}(d_2-x_0)}}
          {\sqrt{2\lambda}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})}\\
    % \end{equation}
    % and  for paths starting in the right hand body, $d_2<x_0$, the solution is
    % \begin{equation}
            f^{(\text{III})}\subTMtwo(x)&= %=  \frac{1}{\sqrt{2(\lambda+\chi_2)}} + \frac{e^{2\sqrt{2(\lambda+\chi_2)}(d+h)}(u\supTM_1 e^{-2\sqrt{2\lambda}d} - u\supTM_2)}{\sqrt{2(\lambda+\chi_2)}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})},
          \dfrac{1}{\sqrt{2(\lambda+\chi_2)}} + \frac{e^{2\sqrt{2(\lambda+\chi_2)}(d_2-x_0)}}{\sqrt{2(\lambda+\chi_2)}}
          \dfrac{(u\supTM_1 e^{-2\sqrt{2\lambda}d}-u\supTM_2)}{(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})},
    \end{align}
  \end{subequations}
  where the TM reflection coefficients for each body are given by 
    \begin{equation}
      u\supTM_i = \frac{e^{2\Xi}\sqrt{\lambda} -\sqrt{\lambda+\chi_i}}{e^{2\Xi}\sqrt{\lambda} + \sqrt{\lambda+\chi_i}}.
    \end{equation}

  % \item {Integrate over position}
%     In exactly the same fashion, we can integrate over position.  
%     \begin{align}
%       I_{TM,12} =& -I_{div} + \dfrac{u\supTM_2 e^{-2\sqrt{2\lambda}d}-u\supTM_1}{4(\lambda+\chi_1)(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})} +\frac{2u\supTM_1u\supTM_2 e^{-\sqrt{2\lambda}d}d}{\sqrt{2\lambda}(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})} + (u\supTM_1+u\supTM_2)\frac{(1-e^{-2\sqrt{2\lambda}d})}{4\lambda(1-u\supTM_1u\supTM_2e^{-2\sqrt{2\lambda}d})}\nonumber\\
%       & +\frac{u\supTM_1 e^{-2\sqrt{2\lambda}d} - u\supTM_2}{4(\lambda+\chi_2)(1-u\supTM_1u\supTM_2 e^{-2\sqrt{2\lambda}d})},
%     \end{align}
%     where $I_{div} = [2(\lambda+\chi_1)]^{-1/2}\int_{-\infty}^h dx_0  +  [2(\lambda+\chi_2)]^{-1/2}\int_{h+d}^\infty dx_0  + (2\lambda)^{-1/2}d$.
%   \item Comment on divergent parts cancelling out. 
% \end{enumerate}
This result contains all of the previous results for closed paths.  The TE results are recovered by By taking $\Xi\rightarrow 0$.
In taking $\chi\rightarrow 0$, the dielectric steps can be ignored, and this is the two body result for just the TM
boundary conditions.  
The equivalent single body results can be found by taking the far body to $x=\pm\infty$.  

These formulae are most useful for showing the analytical agreement with existing 
Casimir energy results.  As such it is best to leave them in this Laplace-transformed form.  
The next chapter uses the results from this chapter to re-derive known analytical results for both 
polarizations for Casimir and Casimir--Polder energies.  

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "thesis_master"
%%% End: 
